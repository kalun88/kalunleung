---
import type { HTMLTag } from "astro/types";
import FormattedDate from "@/components/FormattedDate.astro";
import type { Post } from "@/lib/interfaces";
import { getNotionColorToTailwindColor } from "@/lib/style-helpers";
import { getNavLink, getPostLink, filePath } from "@/lib/blog-helpers";
import { MENU_PAGES_COLLECTION } from "@/constants";
import Icon from "@/components/Icon.astro";
import { slugify } from "@/utils";

interface Props {
	post: Post;
	as?: HTMLTag;
	showPin?: boolean;
}

const { post, as: Tag = "div", showPin = true } = Astro.props;
const postLink = getPostLink(post.Slug, post.Collection === MENU_PAGES_COLLECTION);

// Use FeaturedImages array - show up to 2 images side by side
let selectedImages: string[] = [];
if (post.FeaturedImages && post.FeaturedImages.length > 0) {
	// Take first 2 images if available
	selectedImages = post.FeaturedImages.slice(0, 2).map(img => img.Url);
}
---

<!-- Wide feed layout: 3-column horizontal card -->
<article class="group relative border-b border-gray-200 dark:border-gray-700 pb-6 mb-6 last:border-b-0 last:pb-0 last:mb-0">
	<!-- Main clickable overlay -->
	<a
		href={postLink}
		class="absolute inset-0 z-10 cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
		data-astro-prefetch
		aria-label={`Read: ${post.Title}`}
	></a>

	<div class="grid grid-cols-1 md:grid-cols-[200px_1fr_auto] gap-6 items-start">
		<!-- Column 1: Tags (top) + Date (bottom) -->
		<div class="flex flex-col justify-between min-h-[120px] font-mono">
			<!-- Tags at top -->
			<div class="space-y-1">
				{post.Tags && post.Tags.length > 0 ? (
					post.Tags.slice(0, 3).map((tag) => (
						<a
							class="block text-xs hover:opacity-80 transition-opacity relative z-20"
							style="pointer-events: auto;"
							aria-label={`View more blogs with the tag ${tag.name}`}
							href={getNavLink("/tags/" + slugify(tag.name) + "/")}
						>
							[{tag.name}]
						</a>
					))
				) : (
					<div class="text-xs text-gray-400">[]</div>
				)}
			</div>

			<!-- Date at bottom -->
			<div class="mt-auto">
				<FormattedDate
					date={new Date(post.Date + 'T00:00:00')}
					class="text-xs text-gray-600 dark:text-gray-400"
				/>
			</div>
		</div>

		<!-- Column 2: Title + Excerpt -->
		<div class="flex flex-col justify-center space-y-2">
			<div class="flex items-start gap-2">
				{showPin && post.Pinned && (
					<Icon
						class="h-4 w-4 text-accent flex-shrink-0 mt-1"
						name={"pin"}
						aria-label="Pinned Post"
						focusable="false"
					/>
				)}
				<Tag class="text-xl font-semibold text-gray-900 dark:text-white leading-tight group-hover:text-accent transition-colors">
					{post.Title}
				</Tag>
			</div>

			{post.Excerpt && (
				<p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed line-clamp-3">
					{post.Excerpt}
				</p>
			)}
		</div>

		<!-- Column 3: Cover image(s) - side by side if 2 images -->
		<div class="flex gap-3 items-center justify-end min-w-[200px]">
			{selectedImages.length > 0 ? (
				selectedImages.map((imgUrl, index) => (
					<div class="relative overflow-hidden shadow-sm group-hover:shadow-md transition-shadow">
						<img
							src={imgUrl}
							alt={`Image ${index + 1} for ${post.Title}`}
							class="object-cover transition-transform duration-300 group-hover:scale-105"
							style={selectedImages.length === 1 ? "width: 180px; height: 120px;" : "width: 90px; height: 90px;"}
							loading="lazy"
							decoding="async"
						/>
					</div>
				))
			) : (
				<div class="flex h-28 w-36 items-center justify-center bg-gray-100 dark:bg-gray-800">
					<Icon
						class="h-12 w-12 text-gray-300 dark:text-gray-600"
						name="image"
						aria-hidden="true"
					/>
				</div>
			)}
		</div>
	</div>
</article>
